# 16장 노드와 서버 사이드 자바스크립트

- 노드는 운영체제와 연결된 자바스크립트
- 자바스크립트 프로그램에서 파일을 읽고 쓰고, 자식프로세스를 실행하고, 네트워크를 통해 통신할 수 있게 한다
- 다음과 같은 용도로 사용 할 수 있다
    - 최신 셸 스크립트
    - 신뢰할 수 있는 프로그램을 실행하는 범용 프로그래밍 언어
    - 효율적이고 병렬화된 웹 서버 환경
- 노드의 가장 분명한 특징은 태생부터 비동기적인 API를 바탕으로 한, 싱글스레드의 이벤트 기반 병렬 환경이다.

## 16.1 노드 프로그래밍 기본

### 16.1.1 콘솔 출력

- 노드의 console.log()는 단순히 디버깅에만 쓰이지 않고 사용자에게 메시지를 표시하거나 표준 출력스트림에 출력하는 가장 쉬운 방법
- console.error()는 표준 에러 스트림에 기록한다

### 16.1.2 명령행 인자와 환경 변수

- 문자열 배열인 `process.argv`에서 명령행 인자를 읽을 수 있다
    - 첫번째 요소는 항상 노드 실행 파일의 경로
    - 두번째는 노드가 실행하고 있는 자바스크립트 코드 파일의 경로
    - 남은 요소는 노드를 호출할 때 명령행에 쓴 인자를 공백으로 구분한 결과
    
    ```jsx
    $ node --trace-uncaught argv.js --arg1 --arg2 filename
    
    [
    	'/usr/local/bin/node',
    	'/private/tmp/argv.js',
    	'--arg1',
    	'--arg2',
    	'filename'
    ] 
    ```
    
    - 노드 실행 파일 자체에서 사용하는 명령행 인자는 process.argv에 포험되지 않음
- 유닉스 스타일 환경 변수에서도 입력을 받을 수 있다
    - 이 변수는 `process.env` 객체에 포함된다
    - 이 객체의 프로퍼티 이름은 환경 변수 이름이고 값은 변수 값

### 16.1.3 프로그램 수명

- 노드 프로그램은 초기 파일을 실행하고 콜백을 모두 호출한 뒤 남은 이벤트가 없을 때까지 종료되지 않음
- 네트워크 연결을 주시하는 노드 기반 서버 프로그램은 항상 이벤트를 기다리고 있으므로 이론적으로는 영원히 실행된다
- `process.exit()`를 호출해 프로그램을 강제 종료할 수 있다
- 프로그램에서 예외가 일어났는데 catch절이 없다면 프로그램은 스택 추적을 출력하고 종료된다
    - 노드는 비동기적이므로 콜백이나 이벤트 핸들러에서 일어난 예외는 반드시 그 안에서 처리해야한다
    - 로컬에서 처리하지 않으면 처리할 방법이 전혀 없기때문에 비동기 부분에서 일어나는 예외는 처리하기 쉽지 않음
    - 전역 핸들러 함수를 등록해 프로그램이 충돌하는 일을 막을 수 있다
- 프로미스가 미처리 상태로 거부되어 에러메시지를 출력하거나 프로그램을 종료하는 일을 막으려고 할때도 전역 핸들러 함수를 등록해서 처리한다

### 16.1.4 노드모듈

- 노드13부터는 require기반 모듈 (커먼제이에스모듈) 외에도 es6 모듈 표준도 추가로 지원한다
- 모듈 종류를 알리는 가장 단순한 방법은 파일 확장자로 구분하는 것
- 확장자로 구분할 수 없으면 pakage.json 파일을 찾아서 type 프로퍼티를 체크
- 노드는 es6모듈이 import 키워드를 써서 커먼제이에스 모듈을 불러올 수 있게 허용
    - 반대는 불가능

## 16.2 노드는 기본적으로 비동기적입니다

- 노드는 네트워크 서버처럼 입출력 집약적인 프로그램에 맞게 설계되고 최적화됐다
- 최대한 많은 요청을 동시에 처리할 수 있는 서버를 쉽게 만들 수 있도록 설계됐다
- 대부분의 프로그래밍 언어와 달리 동시성을 스레드로 구현하지 않는다
- 멀티스레드는 정확하게 프로그래밍하기 어렵고 디버그하기도 어렵다
- 또 스레드는 비교적 무거운 작업이므로 많은 요청을 처리하는데 메모리가 많이 필요하다
- 노드는 자바스크립트의 싱글스레드 프로그래밍 모델을 사용한다
- 노드는 기본적으로 비동기, 비차단(nonblocking) 방식 api를 채택해서 싱글스레드 프로그래밍 모델을 유지하면서도 높은 수준의 동시성을 구현한다
- 노드는 비차단 방식을 대단히 중요하게 생각하고 철저히 지킨다
- 자바스크립트가 프로미스를 도입하기전에 만들어졌으므로 비동기 api는 콜백 기반이다
- 비동기 노드 함수에 전달하는 마지막 인자는 일반적으로 콜백이다
- 노드는 인자 두개로 호출되는 오류 우선 콜백을 사용한다
    - 오류 우선 콜백의 첫번째 인자는 일반적으로 에러가 없음을 뜻하는 null
    - 두번째 인자는 호출한 비동기 함수의 데이터 또는 응답
    - 에러 인자를 첫번째로 쓰는 이유는 생략할 수 없게 강제하기 위해서다
- 오류 우선 콜백을 `util.promisfy()` 래퍼를 사용해 프로미스 기반 콜백으로 쉽게 변경할 수 있다.
    - 노드 10 이후 부터는 파일 시스템을 다루는 함수를 프로미스 기반으로 미리 바꾼 함수가 fs.promises 객체에 상당수 존재한다.
- 노드는 기본적으로 비동기지만 프로그래머의 편의를 위해 상당수 함수에 다른 프로세스를 차단하는 동기적 버전 역시 정의했다.
    - 일반적으로 Sync가 붙는다
- 노드에 내장된 비차단 함수는 운영체제의 콜백과 이벤트 핸들러를 이용한다
    - 이런 함수를 호출하면 노드는 해당 작업을 시작한다음 운영체제에 이벤트 핸들러를 등록해서 작업이 완료됐을때 알림을 받는다
    - 이런 형태의 동시성을 이벤트 기반 동시성이라 부른다
    - 노드 코어에는 이벤트루프를 실행하는 스레드가 있다
    

## 16.3 버퍼

- 노드에서 자주사용하는 데이터 타입 중에 버퍼 클래스가 있다
- 버퍼클래스는 파일이나 네트워크에서 데이터를 읽을때 자주 사용한다
- 버퍼는 문자열과 아주 비슷하지만 문자 시퀀스가 아니라 바이트 시퀀스다

## 16.4 이벤트와 이벤트이미터 

## 16.5 스트림

- 데이터를 처리할때 데이터 전체를 메모리에 읽어들이고 이를 처리한다음 내보내는 방식이 가장 쉽다
- copyFile()함수
    - 하지만 파일 전체를 담기에 충분한 메모리를 할당 받아야한다
    - 원본 파일을 다 읽기전에는 사본 파일의 기록을 시작할 수 없다
    - 이 문제의 해결책은 데이터가 프로그램으로 흘러 들어와서 처리되고 다시 흘러나가는 스트리밍 알고리즘이다.
- 스트리밍 알고리즘은 데이터를 항상 작은 덩어리로 처리하고 절대 전체를 메모리에 담지 않는다

## 16.6 프로세스, CPU, 운영체제 세부 사항

- 전역 객체 Process에는 현재 실행중인 노드 프로세스의 상태에 관련된 프로퍼티와 함수가 많이 있다
- os 모듈을 불러오면 컴퓨터와 운영체제에 관한 세부사항을 알 수 있다.
