# 15장 웹 브라우저의 자바스크립트

- 자바스크립트 언어는 웹 브라우저에 표시되는 문서에 동적인 동작을 부여하기 위한 목적으로 1994년에 개발됐다.
- 자바스크립트는 그 후 엄청나게 진화했고, 동시에 웹플랫폼의 범위와 능력도 성장했다.
- 이제 웹을 완전한 애플리케이션 개발 플랫폼으로 생각해도 된다.
- 웹브라우저는 형식화된 텍스트와 이미지를 표시할 의도로 개발됐지만 이제는 네이티브 운영체제와 마찬가지로 그래픽, 비디오, 오디오, 네트워크, 스토리지, 스레드 같은 서비스도 제공한다.
- 노드는 독립적인 실행 환경이며 문서 역시 한곳에서 관리된다.
- 반면 웹 API는 주요 웹 브라우저 제조사들의 협력하에 정의되며, 공식 문서를 통해 API를 사용하는 자바스크립트 프로그래머가 아니라 API를 만드는 C++ 프로그래머를 독자로 상정하고 있다.
- 모질라에서 MDN 웹 문서를 운영하고 있어 믿을 수 있고 자세한 웹 API 문서를 찾아볼 수 있다.

구형 API

- document.write() 메서드 같은 비효율적인 API는 성능에 심각한 영향을 주므로 사용해서는 안된다.
- 동일한 기능을 수행하는 새로운 API로 대체된 지 오래된 API, 예를 들어 document.bgColor는 자바스크립트에서 문서의 배경 색을 설정하기 위해 도입했지만, CSS가 등장하면서 의미를 잃었다.
- 웹의 초기 표준 위원회는 XML문서를 사용하는 자바프로그램에서도, HTML 문서를 사용하는 자바스크립트 프로그램에서도 같은 API를 사용할 수 있도록 문서 객체 모델 API를 특정 언어에 묶이지 않는 방향으로 정의했다.

## 15.1 웹 프로그래밍 기본

### 15.1.1 HTML <script> 태그 속의 자바스크립트

- src 속성의 장점
    - 자바스크립트 코드를 HTML 파일에서 제거해 단순화한다. 내용과 동작을 분리
    - 여러개의 웹페이지에서 같은 자바스크립트 코드를 공유할때 src 속성을 쓰면 코드 하나만 관리해도 된다
    - 자바스크립트 코드를 여러 페이지에서 공유한다면 한 번만 내려받으면 된다.
    - 첫 번째 페이지에서 코드를 내려받으면 다른 페이지는 브라우저 캐시에서 가져올 수 있다.
    - src 속성은 임의의 URL을 값으로 받으므로 한 서버에 있는 자바스크립트 프로그램이나 웹 페이지가 다른 웹 서버에 있는 코드를 가져 올 수 있다.
- 스크립트 타입 지정
    - 웹 초기에는 브라우저에서 자바스크립트가 아닌 다른 언어가 쓰일 것을 염두에 두고 language=”javascript” 나 type=”application/javascript” 같은 속성을 추가했다
    - 하지만 자바스크립트는 웹의 기본 언어이자 유일한 언어이므로 language속성은 폐기됐고 type 속성을 사용하는 경우는 두가지 뿐이다
        - 스크립트가 모듈일때
        - 웹페이지에 데이터를 가져오지만 표시하지는 않을때
- 스크립트 실행시점
    - 웹브라우저가 자바스크립트를 처음 도입했을 때, 이미 렌더링된 문서의 구조와 콘텐츠를 조작하고 문서 간에 이동할 수 있는 api는 존재하지 않았다
    - 자바스크립트 코드가 문서에 영향을 주는 방법은 문서를 불러오고 있는 동안 즉석에서 콘텐츠를 생성하는 것, document.write() 메서드를 사용해 스크립트 위치에 HTML 텍스트를 주입하는 것 뿐이었다.
    - document.write()가 이런 식으로 동작한 다는 건 HTML 파서가 <script> 요소를 만날 때마다 반드시 그 스크립트를 실행해 HTML을 출력하지 않음을 확인한 후에야 문서 분석과 렌더링을 재개할 수 있다는 의미입니다. 이런방식은 웹 페이지의 분석과렌더링 속도를 심하게 저해합니다.
    - <script> 태그에 defer, async 속성을 써서 스크립트 실행 방식을 바꿀 수 있습니다.
        - 단, 이 속성은 src 속성과 함께 사용해야만 의미가 있습니다.
    - defer, async 속성은 모두 연결된 스크립트에 HTML을 만드는 document.write( )가 없으므로 브라우저가 스크립트를 다 내려받을 때까지 기다리지 않고 문서 분석과 렌더링을 계속해도 됩니다 defer 속성은 문서를완전히 내려받고 분석해서 조작 할 준비가 끝날 때까지 스크립트 실행을 지연(defer)하라는 의미입니다.
    - async 속성은 브라우저가 스크립트를 가능한 빨리 실행하되 스크립트를 내려받는 동안 문서 분석을 계속해도 된다는 뜻입니다.
    - <script> 태그에 두 속성이 모두 존재한다면 async 속성이 우선순위를 갖습니다.
    - 지연된 스크립트는 문서 출처 순서대로 실행됩니다. 비동기 스크립트는 불러오는 즉시 실행되므로 문서 출처대로실행되지 않을수도있습니다.
    - type="module" 속성이 있는 스크립트는 기본적으로 defer 속성 이 있는 것처 럼 문서 로딩이 끝난 후 실행됩니다.
    - async속성을 쓰면 문서 로딩이 끝날 때까지 대기하지 않고 가져온 모듈 전부를 불러오는 즉시 실행을 시작합니다.
    - async, defer 속성을 쓰지 않고 스크립트를 HTML 파일의 마지막에 불러오기만 해도 같은 효과를 볼 수 있습니다. 이렇게 하면 브라우저가 문서 로드와 분석을 이미 끝낸 상태이므로 스크립트에서 문서 콘텐츠를 조작해도 안전합니다.

### 15.1.2 문서 객체 모델

- Document 객체는 브라우저 창이나 웹에 표시되는 HTML 문서를 나타내는 객체
- HTML 문서를 다루는 API를 문서 객체 모델，또는 DOM(Document Object Model)이라 부른다.
- DOM API는 HTML 문서의 트리 구조를 반영합니다.
- 문서에 존재하는 HTML 태그마다 그에 대응하는 자바스크립트 Element 객체가 있고， 문서 에 존재하는 텍스트마다 그에 대응하는 Text 객체가 있습니다.
- Element, Text, Document 클래스는 모두 Node 클래스의 서브클래스이며 Node 객체는 트리 구조로 되어 있어， 자바스크립트에서 DOMAPI를 사용해 검색하고 이동할 수 있습니다.
- DOM API에는 새로운 Element,Text 노드를 생성하고 이들을 다른 Element 객체의 자식으로 문서에 삽입하는 메서드가 있습니다.
- 문서 안에서 요소를 이동하거나 완전히 제거하는 메서드도 있습니다.
- 서버 사이드 애플리케이션은 console.log() 로 문자열만 출력할 수 있지만 클라이언트 사이드 자바스크립트 애플라케이션은 DOM API를 사용해 문서 트리를 조작하거나 생성해 HTML로 출력할 수 있습니다.
- 각 HTML 태그 타입에 대응하는 자바스크립트 클래스가 있고 문서에 존재하는 각 태그는 클래스의 인스턴스로 표현됩니다.
    - 예를 들어 <body> 태그는 HTML BodyElement의 인스턴스이고
    - <table> 태그는 HTMLTableElement의 인스턴스 입니다.
- 자바스크립트 Element 객체에는 태그의 HTML 속성에 대응하는 프로퍼티가 있습니다
    - 예를 들어 <lmg> 태그를 나타내는 HTMLImageElement 인스턴스에는 src 속성에 대응하는 src 프로퍼티가 있습니다.
    - src 프로퍼티의 초깃값은 HTML 태그의 속성 값이며 자바스크립트로 이 프로퍼티를 설정하면 HTML 속성 값이 바뀌므로 브라우저가 새로운 이미지를 불러와서 표시합니다.

### 15.1.3 웹 브라우저의 전역 객체

- 브라우저 창이나 탭마다 이에 대응하는 전역객체가 하나씩 있다
- 15.13절에서 설명할 워커 스레드를 제외한 모든 자바스크립트 코드는 전역 객체를 공유한다
- 웹 브라우저에서 전역 객체는 두가지 임무를 수행한다
- 전역 객체는 내장 타입과 함수를 정의하기도 하지만 현재 웹 브라우저 창을 나타내기도 하며 그 창의 브라우징 히스토리를 나타내는 history, 창의 너비를 픽셀로 나타내는 innerWidth 같은 프로퍼티를 정의하기도 한다.
- 전역 객체에는 window 프로퍼티가  있으며 그 값은 전역 객체 자체이다
- 전역 객체와 관련된 기능을 사용할 때는 앞에 window.를 붙이는 편이 좋다

### 15.1.4 네임스페이스를 공유하는 스크립트

- 모듈의 최상위 선언은 그 모듈을 스코프로 가지며 이를 명시적으로 내보낼 수 있습니다.
- 모듈이 아닌 스크립트의 최상위 선언은 포함하는문서를 스코프 로 가지며 문서를 공유한 모든 스크립트에서 해당 선언을 공유합니다.
- var, function 선언은 전역 객체를 통해 프로퍼티를 공유합니다.
- const,let,class 선언 역시 공유되며 문서를 스코프로 갖지만 다른 객체의 프로퍼티로 존재하지는 않습니다.

### 15.1.5 자바스크립트 프로그램 실행

- 자바스크립트 프로그램은 두 단계 (phase)로 실행된다고 생각해도 무방합니다.
- 첫 번째 단계에서는 문서 콘텐츠를 불러오고 <script> 요소의 코드를 실행합니다.
- 문서 로딩이 끝나고 스크립트를 전부 실행하면 자바스크립트는 두 번째 단계에 들어갑니다.
- 이 단계는 비동기적이며 이벤트 주도적입니다.
- 스크립트가 두번째 단계에서 동작하려면 반드시 첫 번째 단계에서 하나 이상의 이벤트 핸들러나 다른콜백 함수를 등록해야 합니다.
- 두 번째 단계에서 처음 일어나는 이벤트 중에는 DOMContentLoaded와 load 이벤트가 있습니다 DOMContentLoaded 이벤트는 HTML 문서의 로딩과 분석이 완전히 끝났을 때 일어납니다
- load 이벤트는 이미지 같은 문서의 외부 자원을 완전히 불러 왔을 때 일어납니다.

클라이언트 사이드 자바스크립트 스레드 모델

- 자바스크립트는 싱글 스레드 언어이며, 싱글 스레드 실행 모델은 두 이벤트 핸들러가 동시에 실행되지 않으므로 프로그래밍이 훨씬 단순하다.
- 콘텐츠를 수정할 때 다른 스레드가 같은 콘텐츠를 동시에 수정하게 될 일도 없고, 락, 교차상태, 경합조건을 걱정할 필요도 없다.
- 싱글스레드는 웹브라우저가 스크립트와 이벤트 핸들러를 살핼하는 동안 사용자 입력에 반응하지 않는다는 의미이다
- 웹 플랫폼은 웹 워커를 통해 동시성을 구현한다
- 웹 워커는 사용자 인터페이스를 멈추지 않으면서 실행되는 백그라운드 스레드이다.

클라이언트 사이드 자바스크립트 타임라인

- 자바스크림트 프로그램은 스크립트 실행 단계에서 이벤트 처리 단계로 넘어간다
- 두 단계는 다음과 같이 여러 단계로 더 나눌 수 있다
    1. 웹 브라우저가 Document객체를 생성하고 웹 페이지 분석을 시작 → html 요소와 텍스트 콘텐츠를 분석할때 마다 Element 객체와 Text노드를 문서에 추가 (이 단계에서 document.readyState 프로퍼티 값은 loading이다
    2. html파서가 async, defer, type=”module” 속성이 없는 script 태그를 만나면 스크립트 태그를 문서에 추가하고 스크립트를 실행, 스크립트는 동기적으로 실행되고 html 파서는 스크립트를 내려 받아 실행하는 동안 일시 중지한다. 이런 스크립트는 document.write()를 사용해 입력 스트림에 텍스트를 삽입할 수 있으며 그 텍스트는 파서가 재개될 때 문서의 일부분이 된다.
    3. 파서가 async 속성이 있는 script 요소를 만나면 스크립트 텍스트를 내려 받기 시작, 비동기 스크립트는 document.write() 메서드를 사용하면 안된다.
    4. 문서 분석이 완전히 끝나면 document.readyState 프로퍼티가 interactive로 변경됨
    5. defer 속성이 있는스크립트, async 속성이 없는모률스크립트는문서 순서대로 실행됩니다.
    6. 브라우저가 Document 객체에서 DOMContentLoaded 이벤트를 일으킨다. 이 시점에서 아직 실행되지 않은 async 스크립트가 있을 수 있다.
    7. 문서 분석을 완전히 끝났지만 브라우저는 이미지 같은 콘텐츠를 기다리고 있을 수 있음. 콘텐츠 로딩이 끝나고 async 스크립트 로딩과 실행도 끝나면 document.readyState 프로퍼티는 complete로 바뀌고 웹브라우저는 Window 객체에서 load 이벤트를 일으킨다
    8. 이제부터 사용자의 입력 이벤트, 네트워크 이벤트, 타이머 종료 등에 의해 이벤트 핸들러가 비동기적으로 호출된다.

15.1.6 프로그램 입출력

- 사용할 수 있는 입력 형태는 다양하다
    - DOM API를 통해 접근할 수 있는 문서 자체
    - 이벤트 형태인 사용자 입력
    - 문서 URL
    - HTTP 쿠키 요청 헤더 콘텐츠
    - 전역 navigator 프로퍼티를 통해 웹 브라우저, 운영 체제와 그 기능에 접근 가능

15.1.7 프로그램 에러

- 운영 체제에서 직접 실행하는 노드와 달리 웹 브라우저의 자바스크립트 프로그램은 충돌하지 않는다
- 잡히지 않은 예외가 일어났을 때 최후의 수단으로 호출될 에러 핸들러가 필요하다면 Window 객체의 onerror 프로퍼티에 에러 핸들러 함수를 정의

15.1.8 웹 보안 모델

- 자바스크립트에서 할 수 없는 일
    - 클라이언트 컴퓨터의 디렉터리를 읽을 수 없고 파일을 수정하거나 삭제할 수 없다
    - 범용 네트워크 기능도 없다. 클라이언트 사이드 자바스크립트로 범용 인터넷 클라이언트와 서버를 만들 수는 없다.
- 동일 출처 정책
    - 동일 출처 정책은 자바스크립트 코드에서 접근할 수 있는 웹콘텐츠를 제어하는 보안 제한
    - 스크립트는 자신을 포함한 문서와 같은 서버에서 가져온 창과 문서의 프로퍼티만 읽을 수 있다.
    - 문서 출처는 그 문서를 불러온 URL의 프로토콜, 호스트, 포트로 정의됩니다. 다른웹 서버에서 가져왔다면출처가 른문서로간주합니다. 호스트가 같더라도 다른 포트에서 가져온 문서는 출처가 다른 것으로 간주합니다.
    - 스크립트 자체의 출처는 동일 출처 정책과 관련이 없지만 스크립트를 포함한 문서의 출처는 관련이 있다.
- 동일 출처 정책 완화하는 방법
    - document.domain을 설정하는 법
    - CORS
        - CORS는 HTTP를 Origin: 요청 헤더와 Acess-Control-Allow-Origin 응답 헤더로 확장한다
- 교차 사이트 스크립트
    - 공격자가 대상 웹사이트에 HTML태그나 스크립트를 주입하는 보안 문제